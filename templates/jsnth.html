<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS-SYNTH WORKSTATION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: sans-serif;
            overflow: hidden;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #10b981;
            margin-top: -4px;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #334155;
            border-radius: 2px;
        }
    </style>
</head>

<body class="h-screen flex flex-col">

    <!-- HEADER -->
    <header class="h-14 bg-slate-950 border-b border-slate-800 flex items-center px-4 justify-between shrink-0">
        <div class="flex items-center gap-2">
            <i data-lucide="activity" class="text-emerald-400"></i>
            <h1 class="font-bold text-lg tracking-wider">JS-SYNTH <span
                    class="text-emerald-400 text-xs">WORKSTATION</span></h1>
        </div>
        <button id="startBtn"
            class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-1 rounded flex items-center gap-2 animate-pulse transition-all">
            <i data-lucide="power" size="16"></i> Start Engine
        </button>
        <div id="engineStatus" class="hidden text-xs text-emerald-500 font-mono">ENGINE ONLINE</div>
    </header>

    <!-- CONTENT -->
    <div class="flex-1 flex overflow-hidden">

        <!-- SIDEBAR -->
        <div class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col p-4 gap-4 overflow-y-auto shrink-0"
            id="trackList">
            <h2 class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-2">Mixer / Tracks</h2>
            <!-- Tracks generated via JS -->
        </div>

        <!-- MAIN -->
        <div class="flex-1 flex flex-col bg-slate-950">

            <!-- VISUALIZER -->
            <div
                class="h-1/2 p-8 flex flex-col items-center justify-center border-b border-slate-800 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 to-slate-950 relative">
                <div class="text-center z-10">
                    <h2 id="activeTrackName" class="text-3xl font-light text-slate-400 mb-2">Drums (TR-606)</h2>
                    <div id="activeTrackType" class="text-slate-600 text-sm font-mono mb-6">CHANNEL 10 MAPPING</div>

                    <div class="h-16 flex items-end justify-center gap-1" id="visualizer">
                        <!-- Bars -->
                    </div>
                </div>
            </div>

            <!-- INPUT SURFACE -->
            <div class="h-1/2 bg-slate-900 p-4 flex flex-col items-center justify-center relative">

                <div id="inputOverlay"
                    class="absolute inset-0 z-20 bg-slate-950/80 flex items-center justify-center backdrop-blur-sm">
                    <div class="text-slate-400">Click "Start Engine" to Initialize</div>
                </div>

                <div class="flex-1 w-full rounded-xl bg-slate-950 border border-slate-800 shadow-inner p-6 flex items-center justify-center relative overflow-hidden"
                    id="inputContainer">
                    <!-- Dynamic Instrument Interface -->
                </div>

                <div class="mt-2 text-center text-xs text-slate-600 font-mono">
                    Use Mouse to Click/Hold notes. For Poly tracks, try holding multiple keys.
                </div>
            </div>

        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- AUDIO ENGINE ---
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.masterGain = null;
                this.trackGains = {};
                this.activeVoices = {};
                this.monoState = {};
            }

            init() {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.5;
                this.masterGain.connect(this.ctx.destination);

                [1, 2, 3, 4, 5, 6].forEach(id => {
                    const gain = this.ctx.createGain();
                    gain.connect(this.masterGain);
                    gain.gain.value = 0.8;
                    this.trackGains[id] = gain;
                    this.activeVoices[id] = {};
                    this.monoState[id] = { osc: null, lastNote: null };
                });
            }

            setTrackVolume(trackId, value) {
                if (this.trackGains[trackId]) {
                    try {
                        this.trackGains[trackId].gain.setTargetAtTime(value, this.ctx.currentTime, 0.05);
                    } catch (e) { }
                }
            }

            triggerDrum(instrumentId, velocity = 1) {
                if (!this.ctx) return;
                const t = this.ctx.currentTime;
                const dest = this.trackGains[1];

                if (instrumentId === 'kick') {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.connect(gain); gain.connect(dest);
                    osc.frequency.setValueAtTime(150, t);
                    osc.frequency.exponentialRampToValueAtTime(40, t + 0.1);
                    gain.gain.setValueAtTime(1 * velocity, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                    osc.start(t); osc.stop(t + 0.5);
                }
                else if (instrumentId === 'snare') {
                    const osc = this.ctx.createOscillator();
                    const oscGain = this.ctx.createGain();
                    osc.type = 'triangle'; osc.connect(oscGain); oscGain.connect(dest);
                    osc.frequency.setValueAtTime(250, t);
                    oscGain.gain.setValueAtTime(0.5 * velocity, t);
                    oscGain.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
                    osc.start(t); osc.stop(t + 0.2);

                    const bufferSize = this.ctx.sampleRate * 2;
                    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                    const noise = this.ctx.createBufferSource();
                    noise.buffer = buffer;
                    const noiseFilter = this.ctx.createBiquadFilter();
                    noiseFilter.type = 'highpass'; noiseFilter.frequency.value = 1000;
                    const noiseGain = this.ctx.createGain();
                    noise.connect(noiseFilter); noiseFilter.connect(noiseGain); noiseGain.connect(dest);
                    noiseGain.gain.setValueAtTime(0.8 * velocity, t);
                    noiseGain.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
                    noise.start(t); noise.stop(t + 0.3);
                }
                else if (['ch', 'oh', 'cp'].includes(instrumentId)) {
                    // CP mapped to HiHat logic roughly for this demo
                    const bufferSize = this.ctx.sampleRate * 2;
                    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1);
                    const noise = this.ctx.createBufferSource();
                    noise.buffer = buffer;
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = 'highpass'; filter.frequency.value = 7000;
                    const gain = this.ctx.createGain();
                    noise.connect(filter); filter.connect(gain); gain.connect(dest);
                    const duration = instrumentId === 'oh' ? 0.4 : 0.05;
                    gain.gain.setValueAtTime(0.6 * velocity, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
                    noise.start(t); noise.stop(t + duration);
                }
                else if (['lt', 'mt', 'ht'].includes(instrumentId)) {
                    const baseFreq = instrumentId === 'lt' ? 80 : (instrumentId === 'mt' ? 120 : 180);
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.connect(gain); gain.connect(dest);
                    osc.frequency.setValueAtTime(baseFreq * 1.5, t);
                    osc.frequency.exponentialRampToValueAtTime(baseFreq * 0.8, t + 0.3);
                    gain.gain.setValueAtTime(0.8 * velocity, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
                    osc.start(t); osc.stop(t + 0.4);
                }
            }

            midiToFreq(note) { return 440 * Math.pow(2, (note - 69) / 12); }

            playMonoNote(trackId, note, type = 'sawtooth', filterFreq = 2000) {
                if (!this.ctx) return;
                const t = this.ctx.currentTime;
                const dest = this.trackGains[trackId];
                const freq = this.midiToFreq(note);

                if (this.monoState[trackId].osc) {
                    this.monoState[trackId].osc.frequency.setTargetAtTime(freq, t, 0.01);
                    this.monoState[trackId].lastNote = note;
                    const env = this.monoState[trackId].env;
                    env.gain.cancelScheduledValues(t);
                    env.gain.setValueAtTime(env.gain.value, t);
                    env.gain.linearRampToValueAtTime(0.8, t + 0.05);
                    return;
                }

                const osc = this.ctx.createOscillator();
                osc.type = type; osc.frequency.value = freq;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass'; filter.frequency.value = filterFreq; filter.Q.value = 5;
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.8, t + 0.02);
                osc.connect(filter); filter.connect(gain); gain.connect(dest);
                osc.start(t);
                this.monoState[trackId] = { osc, gain, env: gain, lastNote: note, filter };
            }

            stopMonoNote(trackId, note) {
                if (!this.ctx || !this.monoState[trackId].osc) return;
                if (this.monoState[trackId].lastNote === note) {
                    const t = this.ctx.currentTime;
                    const { osc, gain } = this.monoState[trackId];
                    gain.gain.cancelScheduledValues(t);
                    gain.gain.setTargetAtTime(0, t, 0.05);
                    osc.stop(t + 0.2);
                    this.monoState[trackId] = { osc: null, lastNote: null };
                }
            }

            playPolyNote(trackId, note, preset) {
                if (!this.ctx) return;
                const t = this.ctx.currentTime;
                const dest = this.trackGains[trackId];
                const freq = this.midiToFreq(note);

                if (this.activeVoices[trackId][note]) this.stopPolyNote(trackId, note);

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();
                osc.frequency.value = freq;

                if (preset === 'piano') {
                    osc.type = 'triangle'; filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(800, t);
                    filter.frequency.exponentialRampToValueAtTime(100, t + 1.5);
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.8, t + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 2);
                } else if (preset === 'strings') {
                    osc.type = 'sawtooth'; filter.type = 'lowpass'; filter.frequency.value = 4000;
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.5, t + 0.5);
                } else if (preset === 'guitar') {
                    osc.type = 'sawtooth'; filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(3000, t);
                    filter.frequency.exponentialRampToValueAtTime(500, t + 0.3);
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.8, t + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 1.0);
                } else {
                    osc.type = 'sine'; gain.gain.setValueAtTime(0.3, t);
                }

                osc.connect(filter); filter.connect(gain); gain.connect(dest);
                osc.start(t);
                this.activeVoices[trackId][note] = { osc, gain };
            }

            stopPolyNote(trackId, note) {
                if (!this.ctx) return;
                const voice = this.activeVoices[trackId][note];
                if (voice) {
                    const t = this.ctx.currentTime;
                    voice.gain.gain.cancelScheduledValues(t);
                    voice.gain.gain.setTargetAtTime(0, t, 0.1);
                    voice.osc.stop(t + 0.2);
                    delete this.activeVoices[trackId][note];
                }
            }
        }

        const audio = new AudioEngine();

        // --- APP STATE ---
        const TRACKS = [
            { id: 1, name: 'Drums (TR-606)', type: 'drum', color: 'bg-red-500', note: 'Chan 10 Logic' },
            { id: 2, name: 'Mono Bass', type: 'mono', preset: 'sawtooth', color: 'bg-indigo-500', note: 'Mono' },
            { id: 3, name: 'Mono Lead', type: 'mono', preset: 'square', color: 'bg-orange-500', note: 'Mono' },
            { id: 4, name: 'Poly Strings', type: 'poly', preset: 'strings', color: 'bg-purple-500', note: 'Poly' },
            { id: 5, name: 'Poly Piano', type: 'poly', preset: 'piano', color: 'bg-blue-500', note: 'Poly' },
            { id: 6, name: 'Poly Guitar', type: 'poly', preset: 'guitar', color: 'bg-green-500', note: 'Poly' },
        ];

        const DRUM_MAP = [
            { note: 36, id: 'kick', label: 'BD' },
            { note: 38, id: 'snare', label: 'SD' },
            { note: 42, id: 'ch', label: 'CH' },
            { note: 46, id: 'oh', label: 'OH' },
            { note: 45, id: 'lt', label: 'LT' },
            { note: 47, id: 'mt', label: 'MT' },
            { note: 50, id: 'ht', label: 'HT' },
            { note: 39, id: 'cp', label: 'CP' },
        ];

        const KEYBOARD_NOTES = [
            { note: 48, label: 'C3', type: 'w' }, { note: 49, label: 'C#', type: 'b' },
            { note: 50, label: 'D3', type: 'w' }, { note: 51, label: 'D#', type: 'b' },
            { note: 52, label: 'E3', type: 'w' }, { note: 53, label: 'F3', type: 'w' },
            { note: 54, label: 'F#', type: 'b' }, { note: 55, label: 'G3', type: 'w' },
            { note: 56, label: 'G#', type: 'b' }, { note: 57, label: 'A3', type: 'w' },
            { note: 58, label: 'A#', type: 'b' }, { note: 59, label: 'B3', type: 'w' },
            { note: 60, label: 'C4', type: 'w' }, { note: 61, label: 'C#', type: 'b' },
            { note: 62, label: 'D4', type: 'w' }, { note: 63, label: 'D#', type: 'b' },
            { note: 64, label: 'E4', type: 'w' }, { note: 65, label: 'F4', type: 'w' },
            { note: 66, label: 'F#', type: 'b' }, { note: 67, label: 'G4', type: 'w' },
            { note: 68, label: 'G#', type: 'b' }, { note: 69, label: 'A4', type: 'w' },
            { note: 70, label: 'A#', type: 'b' }, { note: 71, label: 'B4', type: 'w' },
        ];

        let selectedTrackId = 1;
        let isStarted = false;
        let activeNotes = new Set();

        // --- UI RENDERERS ---

        function renderTracks() {
            const container = document.getElementById('trackList');
            container.innerHTML = '<h2 class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-2">Mixer / Tracks</h2>';

            TRACKS.forEach(track => {
                const isActive = selectedTrackId === track.id;
                const div = document.createElement('div');
                div.className = `p-3 rounded-md border cursor-pointer transition-all ${isActive ? 'bg-slate-800 border-slate-600 ring-1 ring-slate-500' : 'bg-slate-900 border-slate-800 hover:border-slate-700'}`;
                div.onclick = () => { selectedTrackId = track.id; renderUI(); };

                div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold px-1.5 py-0.5 rounded text-white ${track.color}">T${track.id}</span>
                    <span class="text-xs text-slate-400 font-mono">${track.type.toUpperCase()}</span>
                </div>
                <div class="text-sm font-medium text-slate-200 mb-3">${track.name}</div>
                <div class="flex items-center gap-2" onclick="event.stopPropagation()">
                    <i data-lucide="volume-2" class="w-3 h-3 text-slate-500"></i>
                    <input type="range" min="0" max="1" step="0.01" value="0.8" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" oninput="audio.setTrackVolume(${track.id}, this.value)">
                </div>
            `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderVisualizer() {
            // Simple visual bars
            const container = document.getElementById('visualizer');
            container.innerHTML = '';
            const track = TRACKS.find(t => t.id === selectedTrackId);

            for (let i = 0; i < 12; i++) {
                const bar = document.createElement('div');
                // If active notes, animate randomly
                const isActive = activeNotes.size > 0;
                const height = isActive ? (Math.random() * 80 + 20) + '%' : '10%';
                const color = isActive && (i % (activeNotes.size || 1) === 0) ? track.color : 'bg-slate-800';

                bar.className = `w-3 rounded-t-sm transition-all duration-75 ${color}`;
                bar.style.height = height;
                container.appendChild(bar);
            }
        }

        function renderInputSurface() {
            const container = document.getElementById('inputContainer');
            container.innerHTML = '';
            const track = TRACKS.find(t => t.id === selectedTrackId);

            if (track.type === 'drum') {
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-4 gap-4 w-full max-w-2xl';

                DRUM_MAP.forEach(drum => {
                    const isActive = activeNotes.has(drum.note);
                    const btn = document.createElement('button');
                    btn.className = `h-24 rounded-lg border-2 font-bold text-xl transition-all active:scale-95 flex flex-col items-center justify-center gap-1 ${isActive ? 'bg-red-500 border-red-400 text-white shadow-[0_0_15px_rgba(239,68,68,0.5)]' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500 hover:text-slate-200'}`;
                    btn.innerHTML = `<span>${drum.label}</span><span class="text-[10px] opacity-50 font-mono font-normal">MIDI ${drum.note}</span>`;

                    btn.onmousedown = () => noteOn(drum.note);
                    btn.onmouseup = () => noteOff(drum.note);
                    btn.onmouseleave = () => noteOff(drum.note);
                    // Touch support
                    btn.ontouchstart = (e) => { e.preventDefault(); noteOn(drum.note); };
                    btn.ontouchend = (e) => { e.preventDefault(); noteOff(drum.note); };

                    grid.appendChild(btn);
                });
                container.appendChild(grid);
            } else {
                const flex = document.createElement('div');
                flex.className = 'flex items-start justify-center overflow-x-auto pb-4';

                KEYBOARD_NOTES.forEach(k => {
                    const isActive = activeNotes.has(k.note);
                    const btn = document.createElement('button');

                    if (k.type === 'w') {
                        btn.className = `h-48 w-12 border border-slate-400 rounded-b-md -ml-[1px] first:ml-0 relative z-0 transition-colors active:scale-[0.99] origin-top ${isActive ? 'bg-emerald-200 shadow-[inset_0_-10px_20px_rgba(0,0,0,0.1)]' : 'bg-slate-100 hover:bg-white'}`;
                        btn.innerHTML = `<span class="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs text-slate-400 font-bold">${k.label}</span>`;
                    } else {
                        btn.className = `h-32 w-8 bg-slate-900 border border-slate-950 rounded-b-md -mx-4 relative z-10 transition-colors active:scale-[0.99] origin-top shadow-lg ${isActive ? 'bg-emerald-600' : 'bg-slate-900 hover:bg-slate-800'}`;
                    }

                    const trigger = () => noteOn(k.note);
                    const release = () => noteOff(k.note);

                    btn.onmousedown = trigger;
                    btn.onmouseup = release;
                    btn.onmouseleave = release;
                    btn.ontouchstart = (e) => { e.preventDefault(); trigger(); };
                    btn.ontouchend = (e) => { e.preventDefault(); release(); };

                    flex.appendChild(btn);
                });
                container.appendChild(flex);
            }
        }

        function renderUI() {
            const track = TRACKS.find(t => t.id === selectedTrackId);
            document.getElementById('activeTrackName').innerText = track.name;
            document.getElementById('activeTrackType').innerText = track.type === 'drum' ? 'CHANNEL 10 MAPPING' : `${track.type.toUpperCase()} SYNTH ENGINE`;

            renderTracks();
            renderInputSurface();
            renderVisualizer();
        }

        // --- INTERACTION ---

        function noteOn(note) {
            if (!isStarted) return;
            activeNotes.add(note);

            const track = TRACKS.find(t => t.id === selectedTrackId);

            if (track.type === 'drum') {
                // Drum Logic
                const d = DRUM_MAP.find(d => d.note === note);
                if (d) audio.triggerDrum(d.id);
                // Fallback mappings for keyboard
                else {
                    if (note === 48) audio.triggerDrum('kick');
                    if (note === 50) audio.triggerDrum('snare');
                    if (note === 52) audio.triggerDrum('ch');
                    if (note === 53) audio.triggerDrum('oh');
                }
            } else if (track.type === 'mono') {
                audio.playMonoNote(track.id, note, track.preset);
            } else {
                audio.playPolyNote(track.id, note, track.preset);
            }

            renderUI(); // Re-render for visual feedback
        }

        function noteOff(note) {
            if (!isStarted || !activeNotes.has(note)) return;
            activeNotes.delete(note);

            const track = TRACKS.find(t => t.id === selectedTrackId);

            if (track.type === 'mono') audio.stopMonoNote(track.id, note);
            else if (track.type === 'poly') audio.stopPolyNote(track.id, note);

            renderUI();
        }

        // --- INIT ---
        document.getElementById('startBtn').onclick = () => {
            if (!isStarted) {
                audio.init();
                isStarted = true;
                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('engineStatus').classList.remove('hidden');
                document.getElementById('inputOverlay').classList.add('hidden');
            }
        };

        // Loop visualizer
        setInterval(() => {
            if (activeNotes.size > 0) renderVisualizer();
        }, 100);

        renderUI();

    </script>
</body>

</html>