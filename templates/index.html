<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p2mix | Piano Transcription</title>
    <style>
        :root {
            --bg: #121214;
            --surface: #1e1e24;
            --primary: #bb86fc;
            --secondary: #03dac6;
            --text: #e1e1e6;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', system-ui, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .card {
            background: var(--surface);
            padding: 2.5rem;
            border-radius: 16px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            text-align: center;
        }

        h1 {
            margin: 0 0 0.5rem 0;
            font-weight: 300;
            letter-spacing: 3px;
            color: var(--primary);
        }

        .subtitle {
            opacity: 0.6;
            font-size: 0.9rem;
            margin-bottom: 2rem;
            display: block;
        }

        .upload-box {
            border: 2px dashed #333;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .upload-box:hover {
            border-color: var(--primary);
            background: #2a2a35;
        }

        .upload-box.selected {
            border-color: var(--secondary);
            background: #2a3535;
        }

        button {
            background: var(--primary);
            color: #121214;
            border: none;
            padding: 12px 32px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s;
            width: 100%;
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        /* Progress Steps */
        .progress-container {
            margin-top: 2rem;
            display: none;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            color: #666;
        }

        .step {
            position: relative;
        }

        .step.active {
            color: var(--primary);
            font-weight: bold;
        }

        .step.done {
            color: var(--secondary);
        }

        .progress-bar-bg {
            background: #333;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: var(--primary);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .log-output {
            margin-top: 1rem;
            background: #000;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #aaa;
            text-align: left;
            height: 100px;
            overflow-y: auto;
            display: none;
        }

        .success-msg {
            margin-top: 1.5rem;
            color: var(--secondary);
            display: none;
        }
    </style>
</head>

<body>

    <div class="card">
        <h1>p2mix</h1>
        <span class="subtitle">WAV to MIDI Mix System</span>

        <input type="file" id="fileInput" accept=".wav" style="display:none">
        <div class="upload-box" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <p id="fileName">Click or Drop WAV File Here</p>
        </div>

        <button id="startBtn" onclick="startProcess()">Start Processing</button>

        <div class="progress-container" id="progressUI">
            <div class="steps">
                <span id="step1" class="step">Transcribing</span>
                <span id="step2" class="step">Rerecording</span>
                <span id="step3" class="step">Combining</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
            <div class="log-output" id="logOutput"></div>
            <div class="success-msg" id="successMsg">
                <h3>âœ“ Process Complete</h3>
                <p id="finalPath" style="font-size:0.8rem; opacity:0.7;"></p>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const dropZone = document.getElementById('dropZone');
        const startBtn = document.getElementById('startBtn');
        const progressUI = document.getElementById('progressUI');
        const progressBar = document.getElementById('progressBar');
        const logOutput = document.getElementById('logOutput');
        const successMsg = document.getElementById('successMsg');

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                fileName.textContent = fileInput.files[0].name;
                dropZone.classList.add('selected');
            }
        });

        async function startProcess() {
            if (!fileInput.files.length) {
                alert("Please select a file first.");
                return;
            }

            startBtn.disabled = true;
            progressUI.style.display = 'block';
            logOutput.style.display = 'block';
            successMsg.style.display = 'none';

            // Reset steps
            document.querySelectorAll('.step').forEach(s => s.className = 'step');
            progressBar.style.width = '5%';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));

                                // Log output
                                if (data.log) {
                                    const p = document.createElement('div');
                                    p.textContent = "> " + data.log;
                                    logOutput.appendChild(p);
                                    logOutput.scrollTop = logOutput.scrollHeight;
                                }

                                // Update Progress UI
                                if (data.step === 'Transcribing') {
                                    setActiveStep(1);
                                    progressBar.style.width = '33%';
                                } else if (data.step === 'Rendering') {
                                    setActiveStep(2);
                                    progressBar.style.width = '66%';
                                } else if (data.step === 'Combining') {
                                    setActiveStep(3);
                                    progressBar.style.width = '90%';
                                } else if (data.done) {
                                    progressBar.style.width = '100%';
                                    successMsg.style.display = 'block';
                                    document.getElementById('finalPath').textContent = "Saved to: " + data.path;
                                    startBtn.disabled = false;
                                }
                            } catch (e) {
                                console.log("Parse error or non-json message:", line);
                            }
                        }
                    }
                }
            } catch (err) {
                console.error(err);
                alert("An error occurred.");
                startBtn.disabled = false;
            }
        }

        function setActiveStep(num) {
            for (let i = 1; i <= 3; i++) {
                const el = document.getElementById('step' + i);
                if (i < num) el.className = 'step done';
                else if (i === num) el.className = 'step active';
                else el.className = 'step';
            }
        }
    </script>

</body>

</html>